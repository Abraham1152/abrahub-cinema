name: Create Lovable PR
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Create files and open PR (via github-script)
        uses: actions/github-script@v6
        with:
          script: |
            const repo = context.repo;
            const octokit = github.getOctokit(process.env.GH_TOKEN);

            // get default branch
            const { data: repoInfo } = await octokit.rest.repos.get({
              owner: repo.owner,
              repo: repo.repo
            });
            const defaultBranch = repoInfo.default_branch || 'main';
            const newBranch = `lovable/${Date.now()}`;

            // get SHA of default branch
            const { data: ref } = await octokit.rest.git.getRef({
              owner: repo.owner,
              repo: repo.repo,
              ref: `heads/${defaultBranch}`
            });
            const sha = ref.object.sha;

            // create new branch (ref)
            await octokit.rest.git.createRef({
              owner: repo.owner,
              repo: repo.repo,
              ref: `refs/heads/${newBranch}`,
              sha
            });

            // helper to create files on the new branch
            async function createFile(path, content, message) {
              await octokit.rest.repos.createOrUpdateFileContents({
                owner: repo.owner,
                repo: repo.repo,
                path,
                message,
                content: Buffer.from(content, 'utf8').toString('base64'),
                branch: newBranch
              });
            }

            // File contents (small, adjust if needed)
            const lovableWorkflow = `name: Lovable Command Handler

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  handle:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Run lovable handler
        env:
          GITHUB_TOKEN: \${{ secrets.GITHUB_TOKEN }}
          LOVABLE_COMMENT: \${{ github.event.comment.body }}
          ISSUE_NUMBER: \${{ github.event.issue.number }}
          GITHUB_REPOSITORY: \${{ github.repository }}
        run: node .github/lovable/handler.js
`;

            const handlerJs = `#!/usr/bin/env node
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const comment = process.env.LOVABLE_COMMENT || '';
if (!comment.startsWith('/lovable')) {
  console.log('No /lovable command found.');
  process.exit(0);
}

const token = process.env.GITHUB_TOKEN;
const repo = process.env.GITHUB_REPOSITORY;
const issueNumber = process.env.ISSUE_NUMBER;

async function replyToIssue(body) {
  if (!issueNumber) return;
  const [owner, repoName] = repo.split('/');
  await fetch(\`https://api.github.com/repos/\${owner}/\${repoName}/issues/\${issueNumber}/comments\`, {
    method: 'POST',
    headers: { Authorization: \`token \${token}\`, 'Content-Type': 'application/json', 'User-Agent': 'lovable-bot' },
    body: JSON.stringify({ body }),
  });
}

(async () => {
  try {
    const lines = comment.split('\\n');
    const first = lines[0].trim();
    const parts = first.split(' ').filter(Boolean);
    const cmd = parts[1];

    if (!cmd) {
      await replyToIssue('Comando \`/lovable\` inválido. Use \`/lovable create-file <path>\` com um bloco de código contendo o conteúdo do arquivo.');
      return;
    }

    if (cmd === 'create-file') {
      const targetPath = parts[2];
      if (!targetPath) {
        await replyToIssue('Uso: \`/lovable create-file path/to/file.ext\` + bloco de código com o conteúdo.');
        return;
      }

      const codeMatch = comment.match(/```(?:\\w*\\n)?([\\s\\S]*?)```/);
      const content = codeMatch ? codeMatch[1] : null;
      if (content === null) {
        await replyToIssue('Nenhum bloco de código encontrado. Coloque o conteúdo do arquivo dentro de ``` ```.');
        return;
      }

      const branch = \`lovable/\${Date.now()}\`;
      execSync('git config user.name "lovable-bot"');
      execSync('git config user.email "lovable-bot@example.com"');
      execSync(\`git checkout -b \${branch}\`);

      const fullPath = path.join(process.cwd(), targetPath);
      fs.mkdirSync(path.dirname(fullPath), { recursive: true });
      fs.writeFileSync(fullPath, content, 'utf8');

      execSync(\`git add \${targetPath}\`);
      execSync(\`git commit -m "lovable: create \${targetPath}"\`);

      execSync(\`git push https://\${token}@github.com/\${repo}.git HEAD:refs/heads/\${branch}\`, { stdio: 'inherit' });

      const [owner, repoName] = repo.split('/');
      const prResp = await fetch(\`https://api.github.com/repos/\${owner}/\${repoName}/pulls\`, {
        method: 'POST',
        headers: { Authorization: \`token \${token}\`, 'Content-Type': 'application/json', 'User-Agent': 'lovable-bot' },
        body: JSON.stringify({
          title: \`lovable: create \${targetPath}\`,
          head: branch,
          base: 'main',
          body: \`Arquivo criado via comando /lovable create-file \${targetPath}\`
        })
      });
      const prJson = await prResp.json();

      await replyToIssue(\`PR criado: \${prJson.html_url}\`);
      console.log('PR:', prJson.html_url);
      return;
    }

    await replyToIssue(\`Comando \\\`\${cmd}\\\` não suportado. Atualmente suportado: \\\`create-file\\\`.\`);
  } catch (err) {
    console.error(err);
    await replyToIssue(\`Erro ao executar o comando: \${err.message}\`);
    process.exit(1);
  }
})();
`;

            const migrationsWorkflow = `name: Supabase Migrations

on:
  push:
    branches:
      - '${defaultBranch}'

permissions:
  contents: read
  actions: read

jobs:
  run-migrations:
    runs-on: ubuntu-latest
    if: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY != '' }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install supabase CLI
        run: npm i -g supabase
      - name: Run migrations (if any)
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        run: |
          if [ -d "./supabase/migrations" ]; then
            supabase login --service-role "$SUPABASE_SERVICE_ROLE_KEY"
            supabase db push --project-ref "$SUPABASE_URL" || true
          else
            echo "No migrations folder found; skipping."
          fi
`;

            const readme = `Lovable bot — Setup rápido

Usage:
- Add files via issue comments:
  /lovable create-file path/to/file.ext
  \`\`\`
  file content here
  \`\`\`

Secrets required (repository):
- GH_TOKEN (Personal Access Token) — already added.
- SUPABASE_SERVICE_ROLE_KEY — for CI migrations.
- VITE_SUPABASE_URL / VITE_SUPABASE_PUBLISHABLE_KEY — client keys.
`;

            // create files
            await createFile('.github/workflows/lovable.yml', lovableWorkflow, 'Add lovable workflow');
            await createFile('.github/lovable/handler.js', handlerJs, 'Add lovable handler script');
            await createFile('.github/workflows/supabase-migrations.yml', migrationsWorkflow, 'Add supabase migrations workflow');
            await createFile('README_LOVABLE.md', readme, 'Add README_LOVABLE');

            // open PR
            const pr = await octokit.rest.pulls.create({
              owner: repo.owner,
              repo: repo.repo,
              title: 'lovable: add workflows and handler',
              head: newBranch,
              base: defaultBranch,
              body: 'Add lovable workflows and handler (automated)'
            });

            core.setOutput('pr_url', pr.data.html_url);
            console.log('PR created:', pr.data.html_url);
